machine:
  environment:
    PATH: "${HOME}/vagrant/bin:${PATH}"
    TERRAFORM_URL: "https://releases.hashicorp.com/terraform/0.6.8/terraform_0.6.8_linux_amd64.zip"
    TERRAFORM_SHA256SUM: "fd61718820c3f2334276517a89694cebe82db354b584ea90c376f1c6d34bb92d"
    VAGRANT_URL: "https://dl.bintray.com/mitchellh/vagrant/vagrant_1.7.4_x86_64.deb"
    VAGRANT_SHA256SUM: "dcd2c2b5d7ae2183d82b8b363979901474ba8d2006410576ada89d7fa7668336"

dependencies:
  cache_directories:
    - "~/vagrant"
    - "~/bin"
  override:
    - |
      if [ ! -d "${HOME}/vagrant" ]; then
        curl -Lo vagrant.deb "${VAGRANT_URL}"
        sha256sum vagrant.deb
        echo "${VAGRANT_SHA256SUM}  vagrant.deb" | sha256sum -c || exit $?
        sudo dpkg -i vagrant.deb
        cp -aR /opt/vagrant "${HOME}/vagrant"
      fi
    - |
      if [ ! -e "${HOME}/bin/terraform" ]; then
        curl -Lo terraform.zip "${TERRAFORM_URL}"
        echo "${TERRAFORM_SHA256SUM}  terraform.zip" | sha256sum -c || exit $?
        unzip -d ~/bin terraform.zip
      fi

test:
  override:
    - terraform plan -var bucket_name=null bucket
    - find poudriere/portshaker-config -type f -print0 | xargs -0 sh -n
    - find poudriere -name '*.sh' -print0 | xargs -0 sh -n
    - sh -n poudriere/portshaker.conf
    - sh -n poudriere/poudriere.conf
    - sh -n provision.sh
    - vagrant version

